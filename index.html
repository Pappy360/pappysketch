<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PappySketch Smart Canvas</title>
<style>
body {
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  background:#f5f5f7;
  overflow:hidden;
}
header {
  height:60px;
  display:flex;
  align-items:center;
  justify-content:center;
  background:#fff;
  border-bottom:1px solid #d1d1d6;
  font-weight:600;
}
.controls {
  position:fixed;
  top:70px;
  left:10px;
}
.controls input {
  padding:8px 12px;
  border-radius:8px;
  border:1px solid #d1d1d6;
  background:white;
  cursor:pointer;
}
.gallery {
  position:absolute;
  top:60px;
  left:0;
  right:0;
  bottom:0;
  overflow:hidden;
}
.gallery img {
  position:absolute;
  cursor:grab;
  touch-action:none;
  user-select:none;
  transition: left 0.2s, top 0.2s;
}
</style>
</head>
<body>
<header>PappySketch Smart Canvas</header>

<div class="controls">
  <input type="file" id="upload" multiple>
</div>

<div class="gallery" id="gallery"></div>

<script>
const gallery = document.getElementById('gallery');
const upload = document.getElementById('upload');
const spacing = 10;

let drag = null, dx = 0, dy = 0;

upload.onchange = e => {
  const files = [...e.target.files];
  const galleryRect = gallery.getBoundingClientRect();
  const imgs = [];

  files.forEach(f => {
    const img = new Image();
    img.src = URL.createObjectURL(f);
    img.onload = () => {
      // set max width
      img.style.width = Math.min(150, img.naturalWidth) + 'px';
      img.style.height = img.naturalHeight * (parseInt(img.style.width)/img.naturalWidth) + 'px';
      makeDraggable(img);
      gallery.appendChild(img);
      imgs.push(img);

      // auto-arrange images
      if(imgs.length === files.length){
        smartArrange(imgs, galleryRect);
      }
    };
  });
};

function makeDraggable(img){
  img.onmousedown = e => {
    drag = img;
    dx = e.pageX - parseInt(img.style.left);
    dy = e.pageY - parseInt(img.style.top);
    img.style.transition = "none"; // smooth dragging
  };
}

window.onmousemove = e => {
  if(drag){
    drag.style.left = e.pageX - dx + 'px';
    drag.style.top = e.pageY - dy + 'px';
    pushOthers(drag);
  }
};

window.onmouseup = () => {
  if(drag){
    drag.style.transition = "left 0.2s, top 0.2s";
  }
  drag = null;
};

// Smart initial arrangement
function smartArrange(images, rect){
  let x = spacing, y = spacing;
  let rowHeight = 0;
  images.forEach(img => {
    const w = parseInt(img.style.width), h = parseInt(img.style.height);
    if(x + w + spacing > rect.width){
      x = spacing;
      y += rowHeight + spacing;
      rowHeight = 0;
    }
    img.style.left = x + 'px';
    img.style.top = y + 'px';
    x += w + spacing;
    rowHeight = Math.max(rowHeight, h);
  });
}

// Prevent overlap while dragging
function pushOthers(dragImg){
  const imgs = [...gallery.querySelectorAll('img')];
  const dragRect = dragImg.getBoundingClientRect();

  imgs.forEach(img => {
    if(img === dragImg) return;
    const r = img.getBoundingClientRect();

    if(isOverlapping(dragRect, r)){
      // push away
      if(dragRect.top < r.top){
        img.style.top = parseInt(img.style.top) + (dragRect.bottom - r.top + spacing) + 'px';
      } else {
        img.style.top = parseInt(img.style.top) - (r.bottom - dragRect.top + spacing) + 'px';
      }
      if(dragRect.left < r.left){
        img.style.left = parseInt(img.style.left) + (dragRect.right - r.left + spacing) + 'px';
      } else {
        img.style.left = parseInt(img.style.left) - (r.right - dragRect.left + spacing) + 'px';
      }
    }
  });
}

function isOverlapping(a, b){
  return !(a.right + spacing < b.left || 
           a.left - spacing > b.right || 
           a.bottom + spacing < b.top || 
           a.top - spacing > b.bottom);
}

// Responsive layout
window.onresize = () => {
  const galleryRect = gallery.getBoundingClientRect();
  const imgs = [...gallery.querySelectorAll('img')];
  if(imgs.length) smartArrange(imgs, galleryRect);
};
</script>
</body>
</html>
