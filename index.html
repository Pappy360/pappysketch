<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PappySketch</title>

<style>
:root {
  --bg:#f5f5f7; --panel:#fff; --accent:#007aff; --border:#d1d1d6;
}
body {
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  background:var(--bg);
  overflow:hidden;
}
header {
  height:60px;
  display:flex;
  align-items:center;
  justify-content:center;
  background:var(--panel);
  border-bottom:1px solid var(--border);
  font-weight:600;
}
.controls {
  position:fixed;
  top:70px;
  left:10px;
  display:flex;
  flex-direction:column;
  gap:6px;
  z-index:1000;
}
.controls button,input {
  padding:6px 10px;
  border-radius:8px;
  border:1px solid var(--border);
  background:white;
}
.gallery {
  position:absolute;
  inset:60px 260px 0 0;
}
.gallery img {
  position:absolute;
  cursor:grab;
  touch-action:none;
}
.gallery img.selected {
  outline:2px solid var(--accent);
}
.editor {
  position:fixed;
  top:60px;
  right:0;
  width:250px;
  height:calc(100vh - 60px);
  background:var(--panel);
  border-left:1px solid var(--border);
  padding:12px;
  overflow:auto;
}
.editor h3 { font-size:14px; margin:10px 0; }
.editor label { font-size:12px; display:block; margin-bottom:8px; }
.editor input[type=range] { width:100%; }
.editor button {
  width:100%;
  padding:8px;
  border-radius:8px;
  border:none;
  margin-top:6px;
}
.primary { background:var(--accent); color:white; }
.danger { background:#ff3b30; color:white; }

.crop-box {
  position:absolute;
  border:2px dashed var(--accent);
  pointer-events:none;
}
</style>
</head>

<body>
<header>PappySketch</header>

<div class="controls">
  <input type="file" id="upload" multiple>
  <button id="save">Save</button>
  <button id="load">Load</button>
  <button id="export">Export PNG</button>
</div>

<div class="gallery" id="gallery"></div>

<div class="editor">
  <h3>Adjust</h3>
  <label>Brightness <input type="range" id="b" min="50" max="150" value="100"></label>
  <label>Contrast <input type="range" id="c" min="50" max="150" value="100"></label>
  <label>Saturation <input type="range" id="s" min="0" max="200" value="100"></label>
  <label>Warmth <input type="range" id="w" min="-50" max="50" value="0"></label>
  <label>Straighten <input type="range" id="r" min="-45" max="45" value="0"></label>

  <h3>Crop</h3>
  <button class="primary" onclick="startCrop()">Start Crop</button>
  <button onclick="applyCrop()">Apply Crop</button>

  <button onclick="resetEdits()">Reset</button>
  <button class="danger" onclick="deleteImg()">Delete Image</button>
</div>

<script>
const gallery = document.getElementById('gallery');
let selected=null, drag=null, dx=0, dy=0;
let cropBox=null, cropStart=null;

upload.onchange=e=>{
  [...e.target.files].forEach(f=>{
    const img=new Image();
    img.src=URL.createObjectURL(f);
    img.style.left='100px';
    img.style.top='100px';
    img.style.width='220px';
    img.dataset.b=100; img.dataset.c=100; img.dataset.s=100; img.dataset.w=0; img.dataset.r=0;
    makeInteractive(img);
    gallery.appendChild(img);
  });
};

function makeInteractive(img){
  img.onmousedown=e=>{
    select(img);
    drag=img; dx=e.offsetX; dy=e.offsetY;
  };
}

window.onmousemove=e=>{
  if(drag){
    drag.style.left=e.pageX-dx+'px';
    drag.style.top=e.pageY-dy+'px';
  }
  if(cropBox && cropStart){
    cropBox.style.width=Math.abs(e.pageX-cropStart.x)+'px';
    cropBox.style.height=Math.abs(e.pageY-cropStart.y)+'px';
    cropBox.style.left=Math.min(e.pageX,cropStart.x)+'px';
    cropBox.style.top=Math.min(e.pageY,cropStart.y)+'px';
  }
};

window.onmouseup=()=>{ drag=null; cropStart=null; };

function select(img){
  document.querySelectorAll('.gallery img').forEach(i=>i.classList.remove('selected'));
  selected=img; img.classList.add('selected');
  loadSliders();
}

function applyEdits(){
  if(!selected)return;
  selected.style.filter=
    `brightness(${b.value}%) contrast(${c.value}%) saturate(${s.value}%) sepia(${w.value>0?w.value/100:0})`;
  selected.style.transform=`rotate(${r.value}deg)`;
  Object.assign(selected.dataset,{b:b.value,c:c.value,s:s.value,w:w.value,r:r.value});
}
[b,c,s,w,r].forEach(x=>x.oninput=applyEdits);

function loadSliders(){
  b.value=selected.dataset.b||100;
  c.value=selected.dataset.c||100;
  s.value=selected.dataset.s||100;
  w.value=selected.dataset.w||0;
  r.value=selected.dataset.r||0;
  applyEdits();
}

function resetEdits(){
  if(!selected)return;
  selected.style.filter='';
  selected.style.transform='';
}

function deleteImg(){
  if(!selected)return;
  selected.remove(); selected=null;
}

function startCrop(){
  if(!selected)return;
  cropBox=document.createElement('div');
  cropBox.className='crop-box';
  document.body.appendChild(cropBox);
  window.onmousedown=e=>{
    cropStart={x:e.pageX,y:e.pageY};
    cropBox.style.left=e.pageX+'px';
    cropBox.style.top=e.pageY+'px';
  };
}

function applyCrop(){
  if(!cropBox||!selected)return;
  const r=cropBox.getBoundingClientRect();
  selected.style.clipPath=`inset(${r.top-selected.offsetTop}px ${selected.offsetLeft+selected.width-r.right}px ${selected.offsetTop+selected.height-r.bottom}px ${r.left-selected.offsetLeft}px)`;
  cropBox.remove(); cropBox=null;
}

save.onclick=()=>{
  const data=[...gallery.children].map(i=>({src:i.src,style:i.style.cssText,dataset:i.dataset}));
  localStorage.setItem('pappysketch',JSON.stringify(data));
  alert('Saved âœ¨');
};

load.onclick=()=>{
  gallery.innerHTML='';
  JSON.parse(localStorage.getItem('pappysketch')||[]).forEach(d=>{
    const img=new Image();
    img.src=d.src; img.style.cssText=d.style;
    img.dataset=d.dataset;
    makeInteractive(img);
    gallery.appendChild(img);
  });
};

export.onclick=()=>{
  const c=document.createElement('canvas');
  const ctx=c.getContext('2d');
  c.width=gallery.clientWidth;
  c.height=gallery.clientHeight;
  [...gallery.children].forEach(img=>{
    ctx.drawImage(img,parseInt(img.style.left),parseInt(img.style.top),img.width,img.height);
  });
  const a=document.createElement('a');
  a.href=c.toDataURL('image/png');
  a.download='pappysketch.png';
  a.click();
};
</script>
</body>
</html>
