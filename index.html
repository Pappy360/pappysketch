<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PappySketch Smart Canvas</title>
<style>
body {
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  background:#f5f5f7;
  overflow-y: auto;
}
header {
  height:60px;
  display:flex;
  align-items:center;
  justify-content:center;
  background:#fff;
  border-bottom:1px solid #d1d1d6;
  font-weight:600;
  position: sticky;
  top: 0;
  z-index: 1000;
}
.controls {
  position:fixed;
  top:70px;
  left:10px;
  z-index:1001;
}
.controls input, .controls button, .controls select {
  display:block;
  margin-bottom:6px;
  padding:8px 12px;
  border-radius:8px;
  border:1px solid #d1d1d6;
  background:white;
  cursor:pointer;
}
.gallery {
  position: relative;
  top: 60px;
  left:0;
  right:0;
  min-height:100px;
}
.item {
  position: absolute;
}
.item img {
  cursor: grab;
  user-select: none;
  touch-action: none;
}
#lightbox {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 2000;
}
#lightbox img {
  max-width:90%;
  max-height:90%;
  border-radius:12px;
}
#trash {
  position: fixed;
  bottom:16px;
  right:16px;
  width:56px;
  height:56px;
  border-radius:14px;
  background: rgba(0,0,0,0.75);
  color: white;
  display:none;
  align-items:center;
  justify-content:center;
  font-size:24px;
  z-index:3000;
  transition: transform 0.2s, background 0.2s;
}
#trash.active { background:#ff3b30; transform:scale(1.1); }
#undoBtn {
  position: fixed;
  bottom:16px;
  left:16px;
  padding:8px 14px;
  border-radius:10px;
  border:none;
  background:#007aff;
  color:white;
  font-size:14px;
  z-index:3000;
}
#imgMenu {
  position: fixed;
  display: none;
  background: white;
  border: 1px solid #ccc;
  border-radius: 8px;
  z-index: 4000;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}
#imgMenu button {
  display:block;
  padding:8px 12px;
  width:100%;
  border:none;
  background:none;
  text-align:left;
  cursor:pointer;
}
#imgMenu button:hover {
  background:#f0f0f0;
}
</style>
</head>
<body>
<header>PappySketch Smart Canvas</header>

<div class="controls">
  <select id="boardSelect"></select>
  <button id="newBoard">New Board</button>
  <input type="file" id="upload" multiple>
  <button id="exportBtn">Export PNG</button>
  <button id="publishBtn">Publish Board</button>
</div>

<div class="gallery" id="gallery"></div>

<!-- Lightbox -->
<div id="lightbox">
  <img id="lightbox-img">
</div>

<!-- Trash -->
<div id="trash">üóëÔ∏è</div>
<button id="undoBtn" style="display:none;">Undo</button>

<!-- Tap Menu -->
<div id="imgMenu">
  <button id="editBtn">Edit</button>
  <button id="deleteBtn">Delete</button>
</div>

<script>
const gallery = document.getElementById('gallery');
const upload = document.getElementById('upload');
const exportBtn = document.getElementById('exportBtn');
const lightbox = document.getElementById('lightbox');
const lightboxImg = document.getElementById('lightbox-img');
const trash = document.getElementById('trash');
const undoBtn = document.getElementById('undoBtn');
const boardSelect = document.getElementById('boardSelect');
const newBoardBtn = document.getElementById('newBoard');
const publishBtn = document.getElementById('publishBtn');
const imgMenu = document.getElementById('imgMenu');
const editBtn = document.getElementById('editBtn');
const deleteBtn = document.getElementById('deleteBtn');

let spacing = 0, columns = 3;
let drag = null, offsetX=0, offsetY=0, pressTimer=null, HOLD_DELAY=180;
let images = [], undoStack = [];
let boards = JSON.parse(localStorage.getItem('pappysketch-boards') || '["Main"]');
let currentBoard = localStorage.getItem('pappysketch-current') || boards[0];
let selectedItem = null;

// -------------------- Helper Functions --------------------
function boardKey(board){ return `pappysketch-board-${board}`; }
function saveBoards(){ localStorage.setItem('pappysketch-boards', JSON.stringify(boards)); localStorage.setItem('pappysketch-current', currentBoard);}
function clearGallery(){ gallery.innerHTML=''; images=[]; }
function snapToColumns(dragItem){
  const galleryWidth=gallery.clientWidth;
  const colWidth=Math.floor(galleryWidth/columns);
  let left=parseInt(dragItem.style.left);
  let nearestCol=Math.round(left/colWidth);
  nearestCol=Math.max(0,Math.min(columns-1,nearestCol));
  dragItem.style.left = nearestCol*colWidth + 'px';
}
function smartArrange(imgs){
  const galleryWidth=gallery.clientWidth;
  const colWidth=Math.floor(galleryWidth/columns);
  let colHeights=new Array(columns).fill(0);
  imgs.forEach(item=>{
    const img=item.querySelector('img');
    const ratio=img.naturalHeight/img.naturalWidth;
    img.style.width=colWidth+'px';
    img.style.height=colWidth*ratio+'px';
    const col=colHeights.indexOf(Math.min(...colHeights));
    item.style.left = col*colWidth+'px';
    item.style.top = colHeights[col]+'px';
    colHeights[col] += img.offsetHeight;
  });
  gallery.style.height = Math.max(...colHeights)+'px';
}
function pushOthers(dragImg){
  const dragRect=dragImg.getBoundingClientRect();
  images.forEach(item=>{
    if(item===dragImg) return;
    const r=item.getBoundingClientRect();
    if(!(dragRect.right<r.left||dragRect.left>r.right||dragRect.bottom<r.top||dragRect.top>r.bottom)){
      let topMove=0,leftMove=0;
      if(dragRect.bottom>r.top&&dragRect.top<r.top){topMove=dragRect.bottom-r.top;}
      else if(dragRect.top<r.bottom&&dragRect.bottom>r.bottom){topMove=dragRect.top-r.bottom;}
      if(dragRect.right>r.left&&dragRect.left<r.left){leftMove=dragRect.right-r.left;}
      else if(dragRect.left<r.right&&dragRect.right>r.right){leftMove=dragRect.left-r.right;}
      item.style.top=parseInt(item.style.top)+topMove+'px';
      item.style.left=parseInt(item.style.left)+leftMove+'px';
    }
  });
}
function saveLayout(){
  const data=images.map(item=>({src:item.querySelector('img').src}));
  localStorage.setItem(boardKey(currentBoard),JSON.stringify(data));
}
function loadLayout(){
  const saved=JSON.parse(localStorage.getItem(boardKey(currentBoard))||'[]');
  saved.forEach(data=>{
    const item=document.createElement('div');
    item.className='item';
    const img=new Image();
    img.src=data.src;
    item.appendChild(img);
    gallery.appendChild(item);
    images.push(item);
    makeDraggable(item);
    enableTapMenu(item);
  });
  if(images.length) smartArrange(images);
}

// -------------------- Draggable --------------------
function makeDraggable(item){
  const img=item.querySelector('img');
  const startDrag=(x,y)=>{
    drag=item;
    offsetX=x-(parseInt(item.style.left)||0);
    offsetY=y-(parseInt(item.style.top)||0);
    item.style.cursor='grabbing';
    trash.style.display='flex';
  };
  img.onmousedown=e=>{ pressTimer=setTimeout(()=>startDrag(e.pageX,e.pageY),HOLD_DELAY);};
  img.onmouseup=img.onmouseleave=()=>clearTimeout(pressTimer);
  img.ontouchstart=e=>{ const t=e.touches[0]; pressTimer=setTimeout(()=>startDrag(t.pageX,t.pageY),HOLD_DELAY);};
  img.ontouchend=()=>clearTimeout(pressTimer);
}
window.onmousemove=window.ontouchmove=e=>{
  if(!drag) return;
  let x=e.pageX||e.touches[0].pageX;
  let y=e.pageY||e.touches[0].pageY;
  drag.style.left=x-offsetX+'px';
  drag.style.top=y-offsetY+'px';
  pushOthers(drag);
  const t=trash.getBoundingClientRect();
  const d=drag.getBoundingClientRect();
  trash.classList.toggle('active',!(d.right<t.left||d.left>t.right||d.bottom<t.top||d.top>t.bottom));
};
window.onmouseup=window.ontouchend=()=>{
  if(!drag) return;
  const t=trash.getBoundingClientRect();
  const d=drag.getBoundingClientRect();
  const droppedInTrash=!(d.right<t.left||d.left>t.right||d.bottom<t.top||d.top>t.bottom);
  trash.style.display='none';
  trash.classList.remove('active');
  if(droppedInTrash){
    const img = drag.querySelector('img');
    undoStack.push({src:img.src});
    undoBtn.style.display='block';
    drag.remove();
    images=images.filter(i=>i!==drag);
  } else { snapToColumns(drag);}
  drag=null;
  smartArrange(images);
  saveLayout();
};

// -------------------- Tap Menu --------------------
function enableTapMenu(item){
  const img = item.querySelector('img');
  img.addEventListener('click', e=>{
    if(drag) return;
    selectedItem = item;
    imgMenu.style.display = 'block';
    imgMenu.style.left = e.pageX + 'px';
    imgMenu.style.top = e.pageY + 'px';
  });
}

// Hide menu on click elsewhere
window.addEventListener('click', ()=>{
  imgMenu.style.display='none';
  selectedItem=null;
});

// DELETE
deleteBtn.onclick = ()=>{
  if(selectedItem){
    const img = selectedItem.querySelector('img');
    undoStack.push({src: img.src});
    undoBtn.style.display = 'block';
    selectedItem.remove();
    images = images.filter(i=>i!==selectedItem);
    saveLayout();
    imgMenu.style.display='none';
    selectedItem=null;
  }
};

// EDIT (placeholder)
editBtn.onclick = ()=>{
  if(selectedItem){
    alert('Edit feature not implemented yet!');
    imgMenu.style.display='none';
    selectedItem=null;
  }
};

// -------------------- Undo --------------------
undoBtn.onclick=()=>{
  if(!undoStack.length) return;
  const data=undoStack.pop();
  const item=document.createElement('div');
  item.className='item';
  const img=new Image();
  img.src=data.src;
  item.appendChild(img);
  gallery.appendChild(item);
  images.push(item);
  makeDraggable(item);
  enableTapMenu(item);
  smartArrange(images);
  saveLayout();
  if(!undoStack.length) undoBtn.style.display='none';
};

// -------------------- Upload --------------------
upload.onchange=e=>{
  const files=[...e.target.files];
  files.forEach(file=>{
    const img=new Image();
    img.src=URL.createObjectURL(file);
    img.onload=()=>{
      const item=document.createElement('div');
      item.className='item';
      item.appendChild(img);
      gallery.appendChild(item);
      images.push(item);
      makeDraggable(item);
      enableTapMenu(item);
      smartArrange(images);
      saveLayout();
    };
  });
  upload.value='';
};

// -------------------- Export --------------------
exportBtn.onclick=()=>{
  if(!images.length) return;
  let maxRight=0,maxBottom=0;
  images.forEach(item=>{
    const img=item.querySelector('img');
    maxRight=Math.max(maxRight,item.offsetLeft+img.offsetWidth);
    maxBottom=Math.max(maxBottom,item.offsetTop+img.offsetHeight);
  });
  const canvas=document.createElement('canvas');
  canvas.width=maxRight;
  canvas.height=maxBottom;
  const ctx=canvas.getContext('2d');
  ctx.fillStyle='#ffffff';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  images.forEach(item=>{
    const img=item.querySelector('img');
    ctx.drawImage(img,item.offsetLeft,item.offsetTop,img.offsetWidth,img.offsetHeight);
  });
  const link=document.createElement('a');
  link.download=`${currentBoard}.png`;
  link.href=canvas.toDataURL('image/png');
  link.click();
};

// -------------------- Boards --------------------
function refreshBoardUI(){
  boardSelect.innerHTML='';
  boards.forEach(b=>{
    const opt=document.createElement('option');
    opt.value=b; opt.textContent=b;
    if(b===currentBoard) opt.selected=true;
    boardSelect.appendChild(opt);
  });
}
boardSelect.onchange=()=>{
  saveLayout(); clearGallery();
  currentBoard=boardSelect.value;
  loadLayout(); saveBoards();
};
newBoardBtn.onclick=()=>{
  const name=prompt('Board name'); if(!name) return;
  boards.push(name); currentBoard=name; saveBoards();
  refreshBoardUI(); clearGallery();
};
refreshBoardUI(); loadLayout();

// -------------------- Window Resize --------------------
window.onresize=()=>{ if(images.length) smartArrange(images); };
</script>
</body>
</html>
