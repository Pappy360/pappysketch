<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PappySketch Smart Canvas</title>

<!-- Nunito Font -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">

<style>
*{
  font-family:"Nunito",system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
}

body{
  margin:0;
  background:#f5f5f7;
}

header{
  height:60px;
  background:#fff;
  display:flex;
  align-items:center;
  padding:0 12px;
  gap:10px;
  box-shadow:0 2px 8px rgba(0,0,0,0.08);
}

button, select, input[type="file"]{
  height:40px;
  padding:0 14px;
  border-radius:10px;
  border:1px solid #d1d1d6;
  background:#fff;
  font-size:15px;
  cursor:pointer;
}

button:hover, select:hover{
  background:#f2f2f7;
}

#menuToggle{
  width:42px;
  height:42px;
  font-size:20px;
  border-radius:12px;
}

#menu{
  display:none;
  gap:10px;
  align-items:center;
}

.gallery{
  position:relative;
}

.item{
  position:absolute;
}

.item img{
  width:100%;
  cursor:pointer;
  -webkit-user-drag:none;
}

#lightbox{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.85);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
}

#lightboxContent{
  display:flex;
  flex-direction:column;
  gap:14px;
  max-width:90vw;
  max-height:90vh;
}

#lightbox img{
  max-width:90vw;
  max-height:65vh;
  object-fit:contain;
  border-radius:12px;
}

#noteBox{
  width:100%;
  min-height:80px;
  padding:12px;
  font-size:15px;
  border-radius:12px;
  border:1px solid #d1d1d6;
  resize:vertical;
  outline:none;
}

#noteBox:focus{
  border-color:#007aff;
}

#deleteBtn{
  align-self:flex-end;
  height:44px;
  padding:0 16px;
  background:red;
  color:white;
  border:none;
}
</style>
</head>

<body>

<header>
  <button id="menuToggle">☰</button>
  <div id="menu">
    <select id="boardSelect"></select>
    <button id="newBoard">Add Board</button>
    <button id="deleteBoard">Delete Board</button>
    <input type="file" id="upload" multiple>
    <button id="exportBtn">Export PNG</button>
  </div>
</header>

<div class="gallery" id="gallery"></div>

<div id="lightbox">
  <div id="lightboxContent">
    <button id="deleteBtn">Delete</button>
    <img id="lightboxImg">
    <textarea id="noteBox" placeholder="Add a note for this image…"></textarea>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
let db;
const request = indexedDB.open('PappySketchDB',1);

request.onupgradeneeded = e=>{
  db = e.target.result;
  db.createObjectStore('images',{keyPath:'id'});
};

request.onsuccess = e=>{
  db = e.target.result;
  init();
};

const gallery=document.getElementById('gallery');
const upload=document.getElementById('upload');
const boardSelect=document.getElementById('boardSelect');
const menuToggle=document.getElementById('menuToggle');
const menu=document.getElementById('menu');
const lightbox=document.getElementById('lightbox');
const lightboxImg=document.getElementById('lightboxImg');
const deleteBtn=document.getElementById('deleteBtn');
const noteBox=document.getElementById('noteBox');

let images=[];
let activeItem=null;
const columns=3;

let boards=JSON.parse(localStorage.getItem('pappysketch-boards')||'["Main"]');
let currentBoard=localStorage.getItem('pappysketch-current')||boards[0];
const boardKey=b=>`pappysketch-board-${b}`;

function init(){
  refreshBoardUI();
  loadLayout();
}

function refreshBoardUI(){
  boardSelect.innerHTML='';
  boards.forEach(b=>{
    const o=document.createElement('option');
    o.value=b;
    o.textContent=b;
    if(b===currentBoard) o.selected=true;
    boardSelect.appendChild(o);
  });
}

function reflow(){
  const w=gallery.clientWidth;
  const colW=Math.floor(w/columns);
  const heights=new Array(columns).fill(0);

  images.forEach(item=>{
    const img=item.querySelector('img');
    const ratio=img.naturalHeight/img.naturalWidth;
    img.style.width=colW+'px';
    img.style.height=colW*ratio+'px';
    const col=heights.indexOf(Math.min(...heights));
    item.style.left=col*colW+'px';
    item.style.top=heights[col]+'px';
    heights[col]+=img.offsetHeight;
  });
  gallery.style.height=Math.max(...heights,0)+'px';
}

function saveLayout(){
  localStorage.setItem(
    boardKey(currentBoard),
    JSON.stringify(images.map(i=>({id:i.dataset.id})))
  );
}

function loadLayout(){
  gallery.innerHTML='';
  images=[];
  const saved=JSON.parse(localStorage.getItem(boardKey(currentBoard))||'[]');
  const store=db.transaction('images','readonly').objectStore('images');

  saved.forEach(({id})=>{
    store.get(id).onsuccess=e=>{
      if(!e.target.result) return;
      const item=document.createElement('div');
      item.className='item';
      item.dataset.id=id;

      const img=new Image();
      img.src=URL.createObjectURL(e.target.result.blob);
      img.onload=()=>{URL.revokeObjectURL(img.src);reflow();};

      item.appendChild(img);
      gallery.appendChild(item);
      images.push(item);
      makePreviewable(item);
    };
  });
}

upload.onchange=e=>{
  [...e.target.files].forEach(file=>{
    const id=crypto.randomUUID();
    db.transaction('images','readwrite')
      .objectStore('images')
      .put({id,blob:file,note:''});

    const item=document.createElement('div');
    item.className='item';
    item.dataset.id=id;

    const img=new Image();
    img.src=URL.createObjectURL(file);
    img.onload=()=>{URL.revokeObjectURL(img.src);reflow();saveLayout();};

    item.appendChild(img);
    gallery.appendChild(item);
    images.push(item);
    makePreviewable(item);
  });
  upload.value='';
};

function makePreviewable(item){
  item.querySelector('img').onclick=()=>{
    activeItem=item;
    lightboxImg.src=item.querySelector('img').src;
    lightbox.style.display='flex';

    db.transaction('images','readonly')
      .objectStore('images')
      .get(item.dataset.id).onsuccess=e=>{
        noteBox.value=e.target.result?.note||'';
      };
  };
}

noteBox.oninput=()=>{
  if(!activeItem) return;
  const id=activeItem.dataset.id;
  const store=db.transaction('images','readwrite').objectStore('images');
  store.get(id).onsuccess=e=>{
    const data=e.target.result;
    data.note=noteBox.value;
    store.put(data);
  };
};

deleteBtn.onclick=()=>{
  if(!activeItem) return;
  const id=activeItem.dataset.id;
  db.transaction('images','readwrite').objectStore('images').delete(id);
  activeItem.remove();
  images=images.filter(i=>i!==activeItem);
  activeItem=null;
  lightbox.style.display='none';
  reflow();
  saveLayout();
};

lightbox.onclick=e=>{
  if(e.target===lightbox){
    lightbox.style.display='none';
    activeItem=null;
  }
};

menuToggle.onclick=()=>{
  menu.style.display=menu.style.display==='block'?'none':'block';
};

boardSelect.onchange=()=>{
  currentBoard=boardSelect.value;
  localStorage.setItem('pappysketch-current',currentBoard);
  loadLayout();
};

document.getElementById('exportBtn').onclick=async()=>{
  if(!images.length) return;
  const clone=gallery.cloneNode(true);
  document.body.appendChild(clone);
  const canvas=await html2canvas(clone,{scale:2});
  const a=document.createElement('a');
  a.download=currentBoard+'.png';
  a.href=canvas.toDataURL();
  a.click();
  document.body.removeChild(clone);
};
</script>
</body>
</html>
