<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PappySketch Smart Canvas</title>

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  background:#f5f5f7;
  overflow-y:auto;
  user-select:none;
}
header{
  height:60px;
  display:flex;
  align-items:center;
  justify-content:center;
  background:#fff;
  border-bottom:1px solid #d1d1d6;
  font-weight:600;
  position:sticky;
  top:0;
  z-index:1000;
}
.controls{
  position:fixed;
  top:70px;
  left:10px;
  z-index:1001;
}
.controls button,
.controls select,
.controls input{
  display:block;
  margin-bottom:6px;
  padding:8px 12px;
  border-radius:8px;
  border:1px solid #d1d1d6;
  background:white;
  cursor:pointer;
}
.gallery{
  position:relative;
  top:60px;
  min-height:100px;
}
.item{
  position:absolute;
}
.item img{
  cursor:grab;
  touch-action:none;
  user-select:none;
  -webkit-user-drag:none;
}
#trash{
  position:fixed;
  bottom:16px;
  right:16px;
  width:56px;
  height:56px;
  border-radius:14px;
  background:rgba(0,0,0,0.75);
  color:white;
  display:none;
  align-items:center;
  justify-content:center;
  font-size:24px;
  z-index:3000;
}
#undoBtn{
  position:fixed;
  bottom:16px;
  left:16px;
  padding:8px 14px;
  border-radius:10px;
  border:none;
  background:#007aff;
  color:white;
  font-size:14px;
  display:none;
  z-index:3000;
}
#menu{display:none;margin-top:6px;}
</style>
</head>

<body>

<header>PappySketch Smart Canvas</header>

<div class="controls">
  <button id="menuToggle">‚ãØ</button>
  <div id="menu">
    <select id="boardSelect"></select>
    <button id="newBoard">Add Board</button>
    <button id="deleteBoard">Delete Board</button>
    <input type="file" id="upload" multiple>
    <button id="exportBtn">Export PNG</button>
    <button id="publishBtn">Publish Board</button>
  </div>
</div>

<div class="gallery" id="gallery"></div>
<div id="trash">üóëÔ∏è</div>
<button id="undoBtn">Undo</button>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
const gallery = document.getElementById('gallery');
const trash = document.getElementById('trash');
const undoBtn = document.getElementById('undoBtn');
const upload = document.getElementById('upload');
const boardSelect = document.getElementById('boardSelect');
const menuToggle = document.getElementById('menuToggle');
const menu = document.getElementById('menu');

let images = [];
let undoStack = [];
let activeDrag = null;
const columns = 3;

let boards = JSON.parse(localStorage.getItem('pappysketch-boards') || '["Main"]');
let currentBoard = localStorage.getItem('pappysketch-current') || boards[0];

function boardKey(b){ return `pappysketch-board-${b}`; }

function saveBoards(){
  localStorage.setItem('pappysketch-boards',JSON.stringify(boards));
  localStorage.setItem('pappysketch-current',currentBoard);
}

function refreshBoardUI(){
  boardSelect.innerHTML='';
  boards.forEach(b=>{
    const o=document.createElement('option');
    o.value=b;
    o.textContent=b;
    if(b===currentBoard) o.selected=true;
    boardSelect.appendChild(o);
  });
}

function updateGalleryHeight(){
  gallery.style.height = Math.max(
    ...images.map(i=>i.offsetTop+i.offsetHeight),
    0
  )+'px';
}

function reflowMasonry(skip=null){
  const w = gallery.clientWidth;
  const colW = Math.floor(w/columns);
  const heights = new Array(columns).fill(0);

  images.forEach(item=>{
    if(item===skip) return;
    const img=item.querySelector('img');
    const r=img.naturalHeight/img.naturalWidth;
    img.style.width=colW+'px';
    img.style.height=colW*r+'px';
    const col=heights.indexOf(Math.min(...heights));
    item.style.left=col*colW+'px';
    item.style.top=heights[col]+'px';
    heights[col]+=img.offsetHeight;
  });

  updateGalleryHeight();
}

function saveLayout(){
  localStorage.setItem(
    boardKey(currentBoard),
    JSON.stringify(images.map(i=>({
      src:i.querySelector('img').src,
      left:i.style.left,
      top:i.style.top
    })))
  );
}

function clearGallery(){
  gallery.innerHTML='';
  images=[];
}

function loadLayout(){
  const saved=JSON.parse(localStorage.getItem(boardKey(currentBoard))||'[]');
  saved.forEach(d=>{
    const item=document.createElement('div');
    item.className='item';
    item.style.left=d.left;
    item.style.top=d.top;
    const img=new Image();
    img.src=d.src;
    item.appendChild(img);
    gallery.appendChild(item);
    images.push(item);
    makeDraggable(item);
  });
  if(images.length) reflowMasonry();
}

function makeDraggable(item){
  const img=item.querySelector('img');
  let startX,startY,isDragging=false;

  img.addEventListener('mousedown',e=>{
    e.preventDefault();
    isDragging=true;
    startX=e.pageX-(parseInt(item.style.left)||0);
    startY=e.pageY-(parseInt(item.style.top)||0);
    trash.style.display='flex';

    activeDrag={
      move(x,y){
        item.style.left=x-startX+'px';
        item.style.top=y-startY+'px';
      },
      stop(){
        if(!isDragging) return;
        const tr=trash.getBoundingClientRect();
        const it=item.getBoundingClientRect();
        if(it.right>tr.left && it.left<tr.right && it.bottom>tr.top && it.top<tr.bottom){
          undoStack.push({src:img.src});
          undoBtn.style.display='block';
          item.remove();
          images=images.filter(i=>i!==item);
          saveLayout();
          trash.style.display='none';
          isDragging=false;
          activeDrag=null;
          return;
        }
        const colW=Math.floor(gallery.clientWidth/columns);
        let col=Math.round(parseInt(item.style.left)/colW);
        col=Math.max(0,Math.min(columns-1,col));
        item.style.left=col*colW+'px';
        reflowMasonry(item);
        saveLayout();
        trash.style.display='none';
        isDragging=false;
        activeDrag=null;
      }
    };
  });
}

window.addEventListener('mousemove',e=>activeDrag?.move(e.pageX,e.pageY));
window.addEventListener('mouseup',()=>activeDrag?.stop());

upload.onchange=e=>{
  [...e.target.files].forEach(f=>{
    const img=new Image();
    img.src=URL.createObjectURL(f);
    img.onload=()=>{
      URL.revokeObjectURL(img.src);
      const item=document.createElement('div');
      item.className='item';
      item.appendChild(img);
      gallery.appendChild(item);
      images.push(item);
      makeDraggable(item);
      reflowMasonry();
      saveLayout();
    };
  });
  upload.value='';
};

undoBtn.onclick=()=>{
  if(!undoStack.length) return;
  const d=undoStack.pop();
  const item=document.createElement('div');
  item.className='item';
  const img=new Image();
  img.src=d.src;
  item.appendChild(img);
  gallery.appendChild(item);
  images.push(item);
  makeDraggable(item);
  reflowMasonry();
  saveLayout();
  if(!undoStack.length) undoBtn.style.display='none';
};

boardSelect.onchange=()=>{
  saveLayout();
  clearGallery();
  currentBoard=boardSelect.value;
  loadLayout();
  saveBoards();
};

document.getElementById('newBoard').onclick=()=>{
  const n=prompt('Board name');
  if(!n) return;
  boards.push(n);
  currentBoard=n;
  saveBoards();
  refreshBoardUI();
  clearGallery();
};

document.getElementById('deleteBoard').onclick=()=>{
  if(boards.length<=1) return alert('Cannot delete last board');
  if(!confirm(`Delete "${currentBoard}"?`)) return;
  localStorage.removeItem(boardKey(currentBoard));
  boards=boards.filter(b=>b!==currentBoard);
  currentBoard=boards[0];
  saveBoards();
  refreshBoardUI();
  clearGallery();
  loadLayout();
};

menuToggle.onclick=()=>menu.style.display=menu.style.display==='block'?'none':'block';
window.addEventListener('click',e=>{
  if(!menu.contains(e.target)&&e.target!==menuToggle) menu.style.display='none';
});

document.getElementById('exportBtn').onclick=async()=>{
  if(!images.length) return alert('No images to export');
  const clone=gallery.cloneNode(true);
  clone.style.position='absolute';
  clone.style.left='0';
  clone.style.top='0';
  clone.style.background='#f5f5f7';
  document.body.appendChild(clone);
  const canvas=await html2canvas(clone,{scale:2});
  const a=document.createElement('a');
  a.download=currentBoard+'.png';
  a.href=canvas.toDataURL();
  a.click();
  document.body.removeChild(clone);
};

document.getElementById('publishBtn').onclick=()=>alert('Publish not implemented');

refreshBoardUI();
loadLayout();
</script>
</body>
</html>
